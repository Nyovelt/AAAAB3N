---
layout: post
title: "【翻译】Bluetooth Core Specification Version 5.2 Feature Overview"
date: 2021-11-13  10:02:59 +0800
category: Technology
tags: Translation BLE
---
# 【翻译】蓝牙 5.2 核心功能概述
## 总览
### 增强的 ATT 协议
ATT 协议是蓝牙提供的一种基于蓝牙协议的协议，它是蓝牙协议的一部分，用于提供蓝牙设备之间的通信。新的 EATT 协议在 ATT 的基础上有所增强。GATT (Generic Attribute Profile) 协议是 EATT 协议的一部分，它是蓝牙设备之间的通信的核心协议。

EATT 支持并发，可协商的 MTU。 因此在降低延迟和提高效率的同时，EATT 协议提供了更多的功能。

EATT 同时提供了新的 L2CAP 模式 (L2CAP Enhanced Credit Based Flow Control Mode)， 这是一种流量控制协议。

EATT 只能在加密的协议下使用

### LE 功率
现在可以在传输过程中调整传输功率了，这是可协商的。

同时还提出了 `zones` 的概念，这是一种更加灵活的功率控制方式。用来报告链路上的功率消耗。

好处是 
- 动态电源管理
- 最优化信号强度
- 2.4 Ghz 的共存 （因为有很多设备都工作在这一频率）

### LE 同步频道
1 拖 n 的音频播放、音响组的播放，拥有新的音频配置文件



## 增强的 ATT 协议
### 背景
以下是蓝牙 5.1 的部分
#### 具有 GATT、GAP 和 ATT 的低功耗蓝牙堆栈

![UkyE5r](https://oss.aaaab3n.moe/uPic/UkyE5r.png)

LE 分为两个部分，controller 和 host。HCI 提供了链路层到物理层之间的抽象。

同时 LE 支持 mesh。

#### 属性协议 Attribute Protocol
蓝牙设备可能包含一组特殊的数据，称为**Service**、**Characteristics**和**Descriptor**，每一个都是一种属性。所有类型的属性都组织在称为**属性表**的东西。

**Characteristics** 是性能

**Services** 是 Characteristics 的集合，用来表示一个特定的功能，通过表达含义和规则的方式。

**Characteristics** 有很多 **Descriptor**，**Descriptor**类似注册表，例如，客户端特征配置描述符 (CCCD) 允许远程设备启用或禁用包含特征值的通知 PDU 的发送。

ATT 协议提供了一种简单的方式(属性协议)来描述属性表。ATT 客户端 (ATT Client)使用 ATT 来发现远程连接设备 (ATT Server)的属性表。例如，客户端可以查询属性表，并且可以查询属性表中的特征值，并在值改变的时候要求 Server 通知 Client。(但不强制要求可达，分为 notification 和 indication)

ATT 是连接蓝牙设备中的应用程序使用协议定义的 PDU 和更高级别规范（例如通用属性配置文件 (GATT)）中定义的程序相互交互的主要机制之一。

ATT 定义了 **事物 (transaction)**，一个事物包含一个请求和一个响应。大部分 ATT 类型是面向事物的，例如请求和响应。还有与事物无关的，例如通知和命令。

#### 逻辑链路控制和适配协议 (L2CAP)
L2CAP 负责**协议复用**、**流量控制**以及**服务数据单元 (SDU)** 的分段和重组。

![SLl7Hc](https://oss.aaaab3n.moe/uPic/SLl7Hc.png)

L2CAP 使用 **通道 Channel** 来在堆栈层之间传递数据包。其中**固定**的通道无需设置，立即可用，和一个特定的高层协议绑定，比如 ATT 协议。

通道也可以通过指定的协议服务复用器 (PSM) 值**动态**创建并与协议相关联。

##### L2CAP 和协议复用
L2CAP 协议多路复用确保 SDU 向上传递到适当的层进行处理。

##### L2CAP 和流量控制
L2CAP 协议提供了一种简单的流量控制机制，可以控制 SDU 的大小。流控制涉及确保堆栈的一层产生数据包的速率不超过同一堆栈中或远程设备上的层处理这些数据包的速率。没有流量控制，就有风险，比如**buffer 溢出**产生。

基于积分 (Credit)  的流量控制是多种可能的流量控制方法之一。总的来说，它的工作原理如下：

- 发送设备根据它可以处理的 PDU 数量而不丢失数据（例如，通过其缓冲区溢出）了解接收设备的容量。在数据传输开始之前，它通过配置或通过在两个设备之间进行的交换来获取此容量信息。

- 发送设备在每个 PDU 中提供一个 **计数器** 。在数据传输开始之前，它通过配置或通过在两个设备之间进行的交换来获取容量信息。每次发送器发送 PDU 时，计数器都会递减。当计数器值达到零时，发送器知道接收器已满负荷，因此在接收器处理其积压时暂时停止发送更多 PDU。**计数器**就是一个 **Limitation**。

- 而接收器处理完之后会将处理完的数量返回给发送器。计数器会增加。这样发送器就可以**平衡**接收器的处理速度与自己的发送速度。

